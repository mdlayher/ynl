name: dpll

description: |
  DPLL subsystem.

definitions:
  -
    type: flags
    name: genl-get-flags
    value-prefix: dpll-flag-
    entries: [ sources, outputs, status ]
  -
    type: enum
    name: genl-status
    value-prefix: dpll-status-
    entries: [ none, calibrating, locked ]
  -
    type: enum
    name: genl-signal-type
    value-prefix: dpll-type-
    entries: [ none, ext-1pps, ext-10mhz, synce-eth-port, int-oscillator, gnss, custom ]
  -
    type: enum
    name: genl-lock-status
    value-prefix: dpll-lock-status-
    entries: [ unlocked, ext-1pps, ext-10mhz, synce, int-oscillator, gnss ]

attribute-sets:
  -
    name: main
    name-prefix: dplla-
    name-enum: genl-attr
    attributes:
      -
        name: unspec
        type: unused
      -
        name: device-id
        type: u32
      -
        name: device-name
        type: nul-string
        len: DPLL_NAME_LENGTH - 1
      -
        name: source
        type: nest
        multi-attr: true
        nested-attributes: source
      -
        name: source-id
        type: u32
      -
        name: source-type
        type: u32
        enum: genl-signal-type
      -
        name: source-supported
        type: u32
      -
        name: output
        type: nest
        multi-attr: true
        nested-attributes: output
      -
        name: output-id
        type: u32
      -
        name: output-type
        type: u32
        enum: genl-signal-type
      -
        name: output-supported
        type: u32
      -
        name: status
        type: u32
        enum: genl-status
      -
        name: temp
        type: u32
      -
        name: lock-status
        type: u32
        enum: genl-lock-status
      -
        name: flags
        type: u32
        flags-mask: genl-get-flags
  -
    name: source
    subset-of: main
    attributes:
      -
        name: output-id
        type: u32
      -
        name: output-type
        type: u32
        enum: genl-signal-type
      -
        name: output-supported
        type: u32
        multi-attr: true
  -
    name: output
    subset-of: main
    attributes:
      -
        name: source-id
        type: u32
      -
        name: source-type
        type: u32
        enum: genl-signal-type
      -
        name: source-supported
        type: u32
        multi-attr: true

operations:
  enum-model: notify-split
  name-enum: genl-cmd
  async-prefix: dpll-event-
  async-enum: genl-event
  list:
    -
      name: unspec
      description: unused

    -
      name: device-get
      description: Get the device info. TODO..
      attribute-set: main

      do:
        request:
          attributes:
            - device-id
            - device-name
            - flags

        reply:
          attributes:
            - device-id
            - device-name
            - source
            - output
            - status
            - temp
            - lock-status

    -
      name: set-source-type
      description: Set the source type. TODO..
      attribute-set: main
      flags: [ admin-perm ]

      do:
        request:
          attributes:
            - device-id
            - device-name
            - source-id
            - source-type

    -
      name: set-output-type
      description: Set the output type. TODO..
      attribute-set: main
      flags: [ admin-perm ]

      do:
        request:
          attributes:
            - device-id
            - device-name
            - output-id
            - output-type

    -
      name: device-create
      description: New device appeared.
      value: 1
      attribute-set: main
      mcgrp: config
      event:
        attributes:
          - device-id
          - device-name

    -
      name: device-delete
      description: New device appeared.
      attribute-set: main
      mcgrp: config
      event:
        attributes:
          - device-id
          - device-name

    -
      name: status-locked
      description: Device lock status has changed.
      attribute-set: main
      mcgrp: monitor
      event:
        attributes:
          - device-id
          - lock-status

    -
      name: status-unlocked
      description: Device lock status has changed.
      attribute-set: main
      mcgrp: monitor
      event:
        attributes:
          - device-id
          - lock-status

    -
      name: source-change
      description: Device source has changed.
      attribute-set: main
      mcgrp: config-source
      event:
        attributes:
          - device-id
          - source-id
          - source-type

    -
      name: output-change
      description: Device output has changed.
      attribute-set: main
      mcgrp: config-output
      event:
        attributes:
          - device-id
          - output-id
          - output-type

mcast-groups:
  name-prefix: dpll-
  name-suffix: -group-name
  list:
    -
      name: config-device
      value: config
    -
      name: config-source
      value: source
    -
      name: config-output
      value: output
    -
      name: monitor
