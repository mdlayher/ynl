name: nlctrl

description: |
  Generic netlink control protocol. Interface to query information about
  generic netlink families registered in the kernel - their names, ids,
  accepted messages and attributes.

headers:
  uapi: linux/genetlink.h

attribute-sets:
  -
    name: main
    name-prefix: ctrl-attr-
    attributes:
      -
        name: family_id
        type: u16
        description: |
            Numerical identifier of the family.
      -
        name: family_name
        type: nul-string
        len: GENL_NAMSIZ - 1
        description: |
            String identifier of the family. Guaranteed to be unique.
      -
        name: version
        type: u32
      -
        name: hdrsize
        type: u32
      -
        name: maxattr
        type: u32
      -
        name: ops
        type: array-nest
        nested-attributes: operation
      -
        name: mcast_groups
        type: array-nest
        nested-attributes: mcast-group
      -
        name: op
        type: u32
      -
        name: op_policy
        type: nest-type-value
        type-value: [ cmd ]
        nested-attributes: policy
      -
        name: policy
        type: nest-type-value
        type-value: [ current_policy_idx, attr_idx ]
        nested-attributes: nl-policy
  -
    name: operation
    name-prefix: ctrl-attr-op-
    attributes:
      -
        name: id
        type: u32
      -
        name: flags
        type: u32
  -
    name: mcast-group
    name-prefix: CTRL_ATTR_MCAST_GRP_
    attributes:
      -
        name: id
        type: u32
      -
        name: name
        type: nul-string
        len: GENL_NAMSIZ - 1
  -
    name: policy
    name-prefix: ctrl-attr-policy-
    attributes:
      -
        name: do
        type: u32
      -
        name: dump
        type: u32
  -
    name: nl-policy
    name-prefix: nl-policy-type-attr-
    attributes:
      -
        name: type
        type: u32
      -
        name: min_value_u
        type: u64
      -
        name: max_value_u
        type: u64
      -
        name: min_value_s
        type: s64
      -
        name: max_value_s
        type: s64
      -
        name: mask
        type: u64
      -
        name: min_length
        type: u32
      -
        name: max_length
        type: u32
      -
        name: policy_idx
        type: u32
      -
        name: policy_maxtype
        type: u32
      -
        name: bitfield32_mask
        type: u32

operations:
  name-prefix: CTRL_CMD_
  list:
    -
      name: getfamily
      description: Get information about genetlink family.
      attribute-set: main
      dont-validate: [ strict, dump ]

      do:
        request:
          attributes:
            - family_id
            - family_name
        reply: &getfamily-do-reply
          attributes:
            - family_id
            - family_name
            - version
            - hdrsize
            - maxattr
            - ops
            - mcast_groups
      dump:
        reply: *getfamily-do-reply
    -
      name: newfamily
      description: Notification for new families being registered.
      notify: getfamily
    -
      name: delfamily
      description: Notification for families being unregistered.
      notify: getfamily
    -
      name: newmcast_grp
      description: Notification for new multicast groups.
      notify: getfamily
    -
      name: delmcast_grp
      description: Notification for deleted multicast groups.
      notify: getfamily
    -
      name: getpolicy
      description: Get attribute policy for a genetlink family.
      attribute-set: main

      dump:
        request:
          attributes:
            - family_id
            - family_name
            - op
        reply:
          attributes:
            - family_id
            - op_policy
            - policy
