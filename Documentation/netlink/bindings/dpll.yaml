name: dpll

description: |
  DPLL subsystem.

headers:
  uapi: linux/dpll.h

constants:
  -
    type: flags
    name: genl_get_flags
    value-prefix: DPLL_FLAG_
    values: [ sources, outputs, status ]
  -
    type: enum
    name: genl_status
    value-prefix: DPLL_STATUS_
    values: [ none, calibrating, locked ]
  -
    type: enum
    name: genl_signal_type
    value-prefix: DPLL_TYPE_
    values: [ none, ext_1pps, ext_10mhz, synce_eth_port, int_oscillator, gnss, custom ]
  -
    type: enum
    name: genl_lock_status
    value-prefix: DPLL_LOCK_STATUS_
    values: [ unlocked, ext_1pps, ext_10mhz, synce, int_oscillator, gnss ]

attribute-sets:
  -
    name: main
    name-prefix: dplla-
    name-enum: genl_attr
    attributes:
      -
        name: unspec
        type: unused
      -
        name: device_id
        type: u32
      -
        name: device_name
        type: nul-string
        len: DPLL_NAME_LENGTH - 1
      -
        name: source
        type: multi-attr
        sub-type: nest
        nested-attributes: source
      -
        name: source_id
        type: u32
      -
        name: source_type
        type: u32
        enum: genl_signal_type
      -
        name: source_supported
        type: u32
      -
        name: output
        type: multi-attr
        sub-type: nest
        nested-attributes: output
      -
        name: output_id
        type: u32
      -
        name: output_type
        type: u32
        enum: genl_signal_type
      -
        name: output_supported
        type: u32
      -
        name: status
        type: u32
        enum: genl_status
      -
        name: temp
        type: u32
      -
        name: lock_status
        type: u32
        enum: genl_lock_status
      -
        name: flags
        type: u32
        flags-mask: genl_get_flags
  -
    name: source
    subset-of: main
    attributes:
      -
        name: output_id
        type: u32
      -
        name: output_type
        type: u32
        enum: genl_signal_type
      -
        name: output_supported
        type: multi-attr
        sub-type: u32
  -
    name: output
    subset-of: main
    attributes:
      -
        name: source_id
        type: u32
      -
        name: source_type
        type: u32
        enum: genl_signal_type
      -
        name: source_supported
        type: multi-attr
        sub-type: u32

operations:
  name-prefix: DPLL_CMD_
  name-enum: genl_cmd
  async-prefix: DPLL_EVENT_
  async-enum: genl_event
  list:
    -
      name: unspec
      description: unused

    -
      name: device_get
      description: Get the device info. TODO..
      attribute-set: main

      do:
        request:
          attributes:
            - device_id
            - device_name
            - flags

        reply:
          attributes:
            - device_id
            - device_name
            - source
            - output
            - status
            - temp
            - lock_status

    -
      name: set_source_type
      description: Set the source type. TODO..
      attribute-set: main
      flags: [ admin-perm ]

      do:
        request:
          attributes:
            - device_id
            - device_name
            - source_id
            - source_type

    -
      name: set_output_type
      description: Set the output type. TODO..
      attribute-set: main
      flags: [ admin-perm ]

      do:
        request:
          attributes:
            - device_id
            - device_name
            - output_id
            - output_type

    -
      name: device-create
      description: New device appeared.
      value: 1
      attribute-set: main
      mcgrp: config
      event:
        - device_id
        - device_name

    -
      name: device-delete
      description: New device appeared.
      attribute-set: main
      mcgrp: config
      event:
        - device_id
        - device_name

    -
      name: status-locked
      description: Device lock status has changed.
      attribute-set: main
      mcgrp: monitor
      event:
        - device_id
        - lock_status

    -
      name: status-unlocked
      description: Device lock status has changed.
      attribute-set: main
      mcgrp: monitor
      event:
        - device_id
        - lock_status

    -
      name: source-change
      description: Device source has changed.
      attribute-set: main
      mcgrp: config-source
      event:
        - device_id
        - source_id
        - source_type

    -
      name: output-change
      description: Device output has changed.
      attribute-set: main
      mcgrp: config-output
      event:
        - device_id
        - output_id
        - output_type

mcast-groups:
  name-prefix: DPLL_
  name-suffix: _GROUP_NAME
  list:
    -
      name: config-device
      value: config
    -
      name: config-source
      value: source
    -
      name: config-output
      value: output
    -
      name: monitor
